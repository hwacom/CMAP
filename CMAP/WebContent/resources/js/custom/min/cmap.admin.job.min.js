var isModify=!1;function doDelete(){jobAction("delete")}function changeSchedView(e){$("div[id^=sec_]").hide(),""!==e&&(-1!=e.indexOf("sysCheck")?$("#sec_sysCheck").show():$("#sec_"+e).show())}function jobAction(e){var a=$("input[name=chkbox]:checked");if(isModify&&1!=a.length)return alert("修改僅允許勾選一項，請重新選擇"),void uncheckAll();for(var t=new Array,i=new Object,n=0;n<a.length;n++)(i=new Object).keyVal=a[n].value,t.push(i);$.ajax({url:_ctx+"/admin/job/"+e,data:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,success:function(a){"200"==a.code?"modify"==e?($("#inputJobName").val(a.data.inputJobName),$("#inputJobGroup").val(a.data.inputJobGroup),$("#jobKeyName").val(a.data.inputJobName),$("#jobKeyGroup").val(a.data.inputJobGroup),$("#inputCronExpression").val(a.data.inputCronExpression),$("#inputGroupIds").val(a.data.inputGroupIds),$("#inputDeviceIds").val(a.data.inputDeviceIds),$("#inputPriority").val(a.data.inputPriority),$("#inputDescription").val(a.data.inputDescription),$("#inputFtpName").val(a.data.inputFtpName),$("#inputFtpHost").val(a.data.inputFtpHost),$("#inputFtpPort").val(a.data.inputFtpPort),$("#inputFtpAccount").val(a.data.inputFtpAccount),$("#inputFtpPassword").val(a.data.inputFtpPassword),$("#inputSysCheckSql").val(a.data.inputSysCheckSql),$("#inputDataPollerSettingId").val(a.data.inputDataPollerSettingId),$("#inputDataPollerOperatorSettingId").val(a.data.inputDataPollerSettingId),$("#inputLocalFileOperationSettingId").val(a.data.inputLocalFileOperationSettingId),$("#inputMailSenderSettingId").val(a.data.inputMailSenderSettingId),$("#inputMisFirePolicy option").filter(function(){return $(this).val()==a.data.inputMisFirePolicy}).prop("selected",!0),$("#inputSchedType option").filter(function(){return $(this).val()==a.data.inputSchedType}).prop("selected",!0),$("#inputConfigType option").filter(function(){return $(this).val()==a.data.inputConfigType}).prop("selected",!0),$("#inputSchedType").attr("disabled","disabled"),$("#inputJobName").attr("disabled","disabled"),$("#inputJobGroup").attr("disabled","disabled"),$("#sec_"+a.data.inputSchedType).show(),$("#addModifyModal").modal({backdrop:"static"}),"modify"==e&&changeSchedView($("#inputSchedType").val())):(alert(a.message),findData("WEB")):alert(a.message),"403"==a.code&&uncheckAll()},error:function(e,a,t){ajaxErrorHandler()}})}function saveJob(e){var a=$("#formEdit").find(":input:disabled").removeAttr("disabled"),t=JSON.stringify($("#formEdit").serializeObject());a.attr("disabled","disabled"),$.ajax({url:_ctx+"/admin/job/save",data:t,contentType:"application/json; charset=utf-8",type:"POST",dataType:"json",async:!0,success:function(e){"200"==e.code?(alert(e.message),findData("WEB"),setTimeout(function(){$("#addModifyModal").modal("hide")},500)):alert(e.message)},error:function(e,a,t){ajaxErrorHandler()}})}function viewDetail(e){$.ajax({url:_ctx+"/admin/job/getJobDetails.json",data:{jobKeyName:e.split("@~")[0],jobKeyGroup:e.split("@~")[1]},type:"POST",dataType:"json",async:!0,success:function(e){if("200"==e.code){$("#jobDetailsModal").modal(),$("#viewDetailSchedTypeName").val(e.data.schedTypeName),$("#viewDetailConfigType").val(e.data.configType),$("#viewDetailGroupIds").val(e.data.groupId),$("#viewDetailDeviceIds").val(e.data.deviceId),$("#viewDetailFtpName").val(e.data.ftpName),$("#viewDetailFtpHost").val(e.data.ftpHost),$("#viewDetailFtpPort").val(e.data.ftpPort),$("#viewDetailFtpAccount").val(e.data.ftpAccount),$("#viewDetailFtpPassword").val(e.data.ftpPassword),$("#viewDetailSysCheckSql").val(e.data.sysCheckSqls),$("#viewDataPollerSettingId").val(e.data.dataPollerSettingId),$("#viewLocalFileOperationSettingId").val(e.data.localFileOperationSettingId),$("#viewMailSenderSettingId").val(e.data.mailSenderSettingId);var a=e.data.schedType;$("div[id^=sec_detail_]").hide(),""!==a&&(-1!=a.indexOf("sysCheck")?$("#sec_detail_sysCheck").show():$("#sec_detail_"+a).show(),$("#sec_detail_common").show())}else alert(e.message)},error:function(e,a,t){ajaxErrorHandler()}})}function findData(e){$("#queryFrom").val(e),$("input[name=checkAll]").prop("checked",!1),"MOBILE"==e&&$("#collapseExample").collapse("hide"),"undefined"!=typeof resultTable?resultTable.ajax.reload():($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!0,bFilter:!0,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},ajax:{url:_ctx+"/admin/job/getJobInfo.json",type:"POST",data:function(e){},beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},error:function(e,a,t){ajaxErrorHandler()}},order:[[7,"desc"]],drawCallback:function(e){$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust(),$("div.dataTables_length").parent().removeClass("col-sm-12"),$("div.dataTables_length").parent().addClass("col-sm-6"),$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),$("div.dataTables_paginate").parent().removeClass("col-sm-12"),$("div.dataTables_paginate").parent().addClass("col-sm-6"),bindTrEvent(),feather.replace()},columns:[{},{},{},{data:"jobGroup"},{data:"jobName"},{data:"priority"},{data:"triggerState"},{data:"_preFireTime"},{data:"_nextFireTime"},{data:"misfireInstr"},{data:"cronExpression"},{data:"timeZoneId"},{data:"jobClassName"},{},{data:"description"}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(e,a,t){return'<input type="checkbox" id="chkbox" name="chkbox" onclick="changeTrBgColor(this)" value="'+t.jobName+"@~"+t.jobGroup+'">'}},{targets:[1],className:"center",searchable:!1,orderable:!1,render:function(e,a,t,i){return i.row+i.settings._iDisplayStart+1}},{targets:[2],className:"left",searchable:!1,orderable:!1,render:function(e,a,t,i){return t.schedTypeName}},{targets:[13],className:"center",searchable:!1,orderable:!1,render:function(e,a,t){return'<a href="#" onclick="viewDetail(\''+t.jobName+"@~"+t.jobGroup+'\')"><span data-feather="zoom-in"></span></a>'}}]}))}$(document).ready(function(){initMenuStatus("toggleMenu_admin","toggleMenu_admin_items","bk_job"),$("#btnAdd").click(function(){isModify=!1,uncheckAll(),initModal(),$("#addModifyModal").modal({backdrop:"static"})}),$("#btnPause").click(function(){isModify=!1,jobAction("pause")}),$("#btnResume").click(function(){isModify=!1,jobAction("resume")}),$("#btnDelete").click(function(){confirm("確認是否刪除?","doDelete")}),$("#btnModify").click(function(){isModify=!0,jobAction("modify")}),$("#btnSave").click(function(){saveJob(isModify)}),$("#btnExcute").click(function(){jobAction("excute")}),$("#inputSchedType").change(function(){changeSchedView($(this).val())})});