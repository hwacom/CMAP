$(document).ready(function(){$("#onlyOneScript").val();initMenuStatus("toggleMenu_cm","toggleMenu_cm_items","cm_topography")});const fontSize=10,symbolSize=40,padding=10;class Togo{constructor(t,e){this.data=e.data,this.edges=e.edges,this.svg=d3.select(t)}render(){this.scale=1,this.width=this.svg.attr("width"),this.height=this.svg.attr("height"),this.container=this.svg.append("g").attr("transform","scale("+this.scale+")"),this.initPosition(),this.initDefineSymbol(),this.initLink(),this.initNode(),this.initZoom()}initPosition(){let t=[this.width/2,this.height/2],e=this.getVertices(t,.3*Math.min(this.width,this.height),this.data.length);this.data.forEach((t,a)=>{t.x=e[a].x,t.y=e[a].y})}getVertices(t,e,a){if("number"==typeof a){for(var r=t[0],i=t[1],n=360/a,s=0,d=[],o=0;s<a;)o=s*n*Math.PI/180,d.push({x:r+e*Math.sin(o),y:i+e*Math.cos(o)}),s++;return d}}getCenter(t,e,a,r){return[(t+a)/2,(e+r)/2]}getDistance(t,e,a,r){return Math.sqrt(Math.pow(a-t,2)+Math.pow(r-e,2))}getAngle(t,e,a,r){var i=Math.abs(t-a),n=Math.abs(e-r),s=Math.sqrt(i*i+n*n);return Math.round(Math.asin(n/s)/Math.PI*180)}initZoom(){let t=this,e=d3.zoom().scaleExtent([.7,3]).on("zoom",function(){t.onZoom(this)});this.svg.call(e)}initDefineSymbol(){let t=this.container.append("svg:defs");t.selectAll("marker").data(this.edges).enter().append("svg:marker").attr("id",(t,e)=>"marker-"+e).attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -5 10 10").attr("refX",symbolSize/2+padding).attr("refY",0).attr("markerWidth",14).attr("markerHeight",14).attr("orient","auto").attr("stroke-width",2).append("svg:path").attr("d","M2,0 L0,-3 L9,0 L0,3 M2,0 L0,-3").attr("class","arrow");let e=t.append("g").attr("id","database").attr("transform","scale(0.042)");e.append("path").attr("d","M512 800c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V640c0 88.37-200.58 160-448 160z"),e.append("path").attr("d","M512 608c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V448c0 88.37-200.58 160-448 160z"),e.append("path").attr("d","M512 416c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V256c0 88.37-200.58 160-448 160z"),e.append("path").attr("d","M64 224a448 160 0 1 0 896 0 448 160 0 1 0-896 0Z");t.append("g").attr("id","cloud").attr("transform","scale(0.042)").append("path").attr("d","M709.3 285.8C668.3 202.7 583 145.4 484 145.4c-132.6 0-241 102.8-250.4 233-97.5 27.8-168.5 113-168.5 213.8 0 118.9 98.8 216.6 223.4 223.4h418.9c138.7 0 251.3-118.8 251.3-265.3 0-141.2-110.3-256.2-249.4-264.5z")}initLink(){this.drawLinkLine(),this.drawLinkText()}initNode(){var t=this;this.nodes=this.container.selectAll(".node").data(this.data).enter().append("g").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).call(d3.drag().on("drag",function(e){t.onDrag(this,e)})).on("click",function(){alert()}),this.nodes.filter(t=>"app"==t.type).append("circle").attr("r",symbolSize/2+padding).attr("class","node-bg").attr("fill","red"),this.nodes.filter(t=>"app"!=t.type).append("circle").attr("r",padding).attr("fill","white"),this.drawNodeSymbol(),this.drawNodeTitle(),this.drawNodeOther(),this.drawNodeCode()}drawNodeCode(){this.nodeCodes=this.nodes.filter(t=>"app"==t.type).append("g").attr("class","node-code").attr("transform","translate("+-symbolSize/2+","+symbolSize/3+")"),this.nodeCodes.append("circle").attr("r",t=>fontSize/2*t.code.length/2+3).attr("fill","ble").transition().attr("fill","steelblue"),this.nodeCodes.append("text").attr("dy",fontSize/2).text(t=>t.code)}drawNodeSymbol(){this.nodes.filter(t=>"app"==t.type).append("circle").attr("r",symbolSize/2).attr("fill","#fff").attr("class",function(t){return"health"+t.health}).attr("stroke-width","5px"),this.nodes.filter(t=>"database"==t.type).append("use").attr("xlink:href","#database").attr("x",function(){return-this.getBBox().width/2}).attr("y",function(){return-this.getBBox().height/2}),this.nodes.filter(t=>"server"==t.type).append("use").attr("xlink:href","#server").attr("x",function(){return-this.getBBox().width/2}).attr("y",function(){return-this.getBBox().height/2}),this.nodes.filter(t=>"cloud"==t.type).append("use").attr("href","#cloud").attr("x",function(){return-this.getBBox().width/2}).attr("y",function(){return-this.getBBox().height/2}).attr("width","40").attr("height","40")}drawNodeOther(){this.nodeOthers=this.nodes.filter(t=>"app"==t.type).append("text").attr("x",symbolSize/2+padding).attr("y",-5).attr("class","node-other"),this.nodeOthers.append("tspan").text(t=>t.time+"ms"),this.nodeOthers.append("tspan").text(t=>t.rpm+"rpm").attr("x",symbolSize/2+padding).attr("dy","1em"),this.nodeOthers.append("tspan").text(t=>t.epm+"epm").attr("x",symbolSize/2+padding).attr("dy","1em")}drawNodeTitle(){this.nodes.append("text").attr("class","node-title").text(function(t){return t.name}).attr("dy",symbolSize),this.nodes.filter(t=>"app"==t.type).append("text").text(function(t){return t.active+"/"+t.total}).attr("dy",fontSize/2).attr("class","node-call")}drawLinkLine(){let t=this.data;function e(e){let a=t[e.source].x,r=t[e.target].x;return"M"+a+","+t[e.source].y+" L"+r+","+t[e.target].y}this.lineGroup?this.lineGroup.selectAll(".link").attr("d",t=>e(t)):(this.lineGroup=this.container.append("g"),this.lineGroup.selectAll(".link").data(this.edges).enter().append("path").attr("class","link").attr("marker-end",(t,e)=>"url(#marker-"+e+")").attr("d",t=>e(t)).attr("id",(t,e)=>"link-"+e).attr("stroke","black").attr("stroke-width","1px").attr("fill","none").on("click",()=>{alert()}))}drawLinkText(){let t=this.data,e=this;function a(a){let r=t[a.source],i=t[a.target],n=e.getCenter(r.x,r.y,i.x,i.y),s=e.getAngle(r.x,r.y,i.x,i.y);return(r.x>i.x&&r.y<i.y||r.x<i.x&&r.y>i.y)&&(s=-s),"translate("+n[0]+","+n[1]+") rotate("+s+")"}this.lineTextGroup?this.lineTexts.attr("transform",a):(this.lineTextGroup=this.container.append("g"),this.lineTexts=this.lineTextGroup.selectAll(".linetext").data(this.edges).enter().append("text").attr("dy",-2).attr("transform",a).on("click",()=>{alert()}),this.lineTexts.append("tspan").text((t,e)=>this.data[t.source].lineTime+"ms,"+this.data[t.source].lineRpm+"rpm"),this.lineTexts.append("tspan").text((t,e)=>this.data[t.source].lineProtocol).attr("dy","1em").attr("dx",function(){return-this.getBBox().width/2}))}update(t){this.drawLinkLine(),this.drawLinkText()}onDrag(t,e){e.x=d3.event.x,e.y=d3.event.y,d3.select(t).attr("transform","translate("+d3.event.x+","+d3.event.y+")"),this.update(e)}onZoom(t){var e=d3.zoomTransform(t);this.scale=e.k,this.container.attr("transform","translate("+e.x+","+e.y+")scale("+e.k+")")}}