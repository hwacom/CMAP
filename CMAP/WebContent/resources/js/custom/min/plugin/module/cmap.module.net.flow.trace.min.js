var timer,startTime,timer_start,timer_end,startNum,pageLength,waitForNextData=!1,lastScrollYPos=0;function doDataExport(e){var t=new Object;"WEB"==$("#queryFrom").val()?(t.queryGroup=$("#queryGroup").val(),t.querySourceIp=$("#query_SourceIp").val(),t.queryDestinationIp=$("#query_DestinationIp").val(),t.querySenderIp=$("#query_SenderIp").val(),t.querySourcePort=$("#query_SourcePort").val(),t.queryDestinationPort=$("#query_DestinationPort").val(),t.queryDateBegin=$("#queryDateBegin").val(),t.queryTimeBegin=$("#queryTimeBegin").val(),t.queryTimeEnd=$("#queryTimeEnd").val()):"MOBILE"==$("#queryFrom").val()&&(t.queryGroup=$("#queryGroup_mobile").val(),t.querySourceIp=$("#query_SourceIp_mobile").val(),t.queryDestinationIp=$("#query_DestinationIp_mobile").val(),t.querySenderIp=$("#query_SenderIp_mobile").val(),t.querySourcePort=$("#query_SourcePort_mobile").val(),t.queryDestinationPort=$("#query_DestinationPort_mobile").val(),t.queryDateBegin=$("#queryDateBegin_mobile").val(),t.queryTimeBegin=$("#queryTimeBegin").val(),t.queryTimeEnd=$("#queryTimeEnd").val()),t.start=0,t.length=pageLength,t.searchValue=$("#resultTable_filter").find("input").val(),t.exportRecordCount=e,$.ajax({url:_ctx+"/plugin/module/netFlowTrace/dataExport.json",data:t,type:"POST",dataType:"json",async:!0,beforeSend:function(e){showProcessing()},complete:function(){hideProcessing()},initComplete:function(e,t){},success:function(e){if(200==e.code){const t=e.data.fileId,r=getResourceDownloadLink(t);location.href=r,closeExportPanel()}else alert(e.message)},error:function(e,t,r){ajaxErrorHandler()}})}function countDown(e){if("START"==e)startTime=parseInt(_timeout)-1,timer_start=performance.now(),timer=setInterval(function(){$("#timeoutMsg").val("Timeout倒數 : "+startTime+" 秒"),startTime--},1e3);else{timer_end=performance.now();var t=(parseInt(timer_end)-parseInt(timer_start))/1e3;$("#timeoutMsg").val("查詢花費時間 : "+t+" 秒"),clearInterval(timer)}}function bindScrollEvent(){$(".dataTables_scrollBody").scroll(function(e){if(0==$(".dataTables_empty").length){var t=$("#resultTable > tBody > tr").length,r=$(this).prop("scrollTop"),a=$(this).prop("scrollHeight")-$(this).prop("clientHeight");r>lastScrollYPos&&(lastScrollYPos=r,t>=pageLength&&r>=a-100&&(waitForNextData||(waitForNextData=!0,findNextData())))}})}function unbindScrollEvent(){$(".dataTables_scrollBody").off("scroll")}function addRow(e){for(var t=0;t<e.length;t++){var r=e[t],a=$("#resultTable > tBody > tr").length,o=$("#resultTable > tbody > tr:eq(0)").clone();$(o).find("td:eq(0)").html(++a),$(o).find("td:eq(1)").html(r.groupName),$(o).find("td:eq(2)").html(r.fromDateTime),$(o).find("td:eq(3)").html('<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.sourceIPInGroup+"','"+r.groupName+"','"+r.sourceIP+"')\">"+r.sourceIP+"</a>"),$(o).find("td:eq(4)").html(r.sourcePort),$(o).find("td:eq(5)").html(r.sourceMAC),$(o).find("td:eq(6)").html('<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.destinationIPInGroup+"','"+r.groupName+"','"+r.destinationIP+"')\">"+r.destinationIP+"</a>"),$(o).find("td:eq(7)").html(r.destinationPort),$(o).find("td:eq(8)").html(r.destinationMAC),$(o).find("td:eq(9)").html(r.size),$(o).find("td:eq(10)").html(r.session),$(o).find("td:eq(11)").html(r.protocol),$(o).find("td:eq(12)").html(r.inboundInterface),$(o).find("td:eq(13)").html(r.outboundInterface),$(o).find("td:eq(14)").html(r.nextHop),$("#resultTable > tbody").append($(o))}$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust()}function getTotalTraffic(){$("#div_TotalFlow").css("display","contents"),$.ajax({url:_ctx+"/plugin/module/netFlowTrace/getTotalTraffic.json",data:{queryGroup:$("#queryGroup").val(),querySourceIp:$("#query_SourceIp").val(),queryDestinationIp:$("#query_DestinationIp").val(),querySenderIp:$("#query_SenderIp").val(),querySourcePort:$("#query_SourcePort").val(),queryDestinationPort:$("#query_DestinationPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),searchValue:$("#resultTable_filter").find("input").val()},type:"POST",dataType:"json",async:!0,beforeSend:function(e){$("#result_TotalFlow").text("總流量："),$("#searchWaiting").show()},complete:function(){$("#searchWaiting").hide()},initComplete:function(e,t){},success:function(e){var t=e.data.TTL_TRAFFIC;"EMPTY"===t?$("#result_TotalFlow").text("查無符合資料"):$("#result_TotalFlow").text("總流量："+t)},error:function(e,t,r){$("#result_TotalFlow").text("查無符合資料")}})}function getTotalFilteredCount(){$.ajax({url:_ctx+"/plugin/module/netFlowTrace/getTotalFilteredCount.json",data:{queryGroup:$("#queryGroup").val(),querySourceIp:$("#query_SourceIp").val(),queryDestinationIp:$("#query_DestinationIp").val(),querySenderIp:$("#query_SenderIp").val(),querySourcePort:$("#query_SourcePort").val(),queryDestinationPort:$("#query_DestinationPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),searchValue:$("#resultTable_filter").find("input").val()},type:"POST",dataType:"json",async:!0,beforeSend:function(e){var t,r;0==$(".dataTables_empty").length?(t=1,r=$("#resultTable > tBody > tr").length):(t=0,r=0),$("#resultTable_info").html('<div class="row" style="padding-left: 15px;"><div id="current_count">顯示第 '+t+" 至 "+r+' 項結果，共</div><div id="total_count"><img id="searchWaiting2" class="img_searchWaiting" alt="loading..." src="/resources/images/Processing_4.gif"></div><div style="">筆</div></div>')},complete:function(){$("#searchWaiting2").hide()},initComplete:function(e,t){},success:function(e){var t=e.data.FILTERED_COUNT;$("#total_count").html("&nbsp;"+t+"&nbsp;")},error:function(e,t,r){$("#total_count").html("&nbsp;N/A&nbsp;")}})}function findNextData(){var e,t=-1;$(".dataTable > thead").find(".sorting_asc").length>0?t=$(".dataTable > thead").find(".sorting_asc").prop("cellIndex"):$(".dataTable > thead").find(".sorting_desc").length>0&&(t=$(".dataTable > thead").find(".sorting_desc").prop("cellIndex")),e="descending"===$(".dataTable > thead > tr > th:eq("+t+")").attr("aria-sort")?"desc":"asc",$.ajax({url:_ctx+"/plugin/module/netFlowTrace/getNetFlowData.json",data:{queryGroup:$("#queryGroup").val(),querySourceIp:$("#query_SourceIp").val(),queryDestinationIp:$("#query_DestinationIp").val(),querySenderIp:$("#query_SenderIp").val(),querySourcePort:$("#query_SourcePort").val(),queryDestinationPort:$("#query_DestinationPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),start:startNum,length:pageLength,searchValue:$("#resultTable_filter").find("input").val(),"order[0][column]":t,"order[0][dir]":e},type:"POST",dataType:"json",async:!0,beforeSend:function(e){countDown("START"),showProcessing()},complete:function(){countDown("STOP"),hideProcessing(),waitForNextData=!1},initComplete:function(e,t){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg))},success:function(e){var t,r,a=e.data.length;console.log("query success... count: "+a),a>0&&(addRow(e.data),startNum+=pageLength),0==$(".dataTables_empty").length?(t=1,r=$("#resultTable > tBody > tr").length):(t=0,r=0),$("#current_count").text("顯示第 "+t+" 至 "+r+" 項結果，共")},error:function(e,t,r){$("#current_count").text("<ERROR>"),ajaxErrorHandler()}})}function viewIpPort(e,t,r,a,o){var n=new Object;n.groupId=e,n.fromDateTime=t,n.groupName=a,n.ipAddress=o,$.ajax({url:_ctx+"/plugin/module/ipTracePoller/getIpTraceDataFromNetFlow.json",data:JSON.stringify(n),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(e){if("200"==e.code){var t="";$("#viewIpMappingPortModal_groupName").parent().show(),"Y"==r?($("#viewIpMappingPortModal_deviceName").parent().show(),$("#viewIpMappingPortModal_deviceModel").parent().show(),$("#viewIpMappingPortModal_portName").parent().show(),$("#viewIpMappingPortModal_country").parent().hide(),t="IP is in the group subnet"):($("#viewIpMappingPortModal_deviceName").parent().hide(),$("#viewIpMappingPortModal_deviceModel").parent().hide(),$("#viewIpMappingPortModal_portName").parent().hide(),$("#viewIpMappingPortModal_country").parent().show(),t="IP is not in the group subnet"),$("#viewIpMappingPortModal_ipAddress").parent().show(),$("#viewIpMappingPortModal_ipDesc").parent().show(),$("#viewIpMappingPortModal_showMsg").parent().show(),$("#viewIpMappingPortModal_groupName").html(e.data.groupName),$("#viewIpMappingPortModal_deviceName").html(e.data.deviceName),$("#viewIpMappingPortModal_deviceModel").html(e.data.deviceModel),$("#viewIpMappingPortModal_ipAddress").html(e.data.ipAddress),$("#viewIpMappingPortModal_ipDesc").html(e.data.ipDesc),$("#viewIpMappingPortModal_portName").html(e.data.portName),$("#viewIpMappingPortModal_showMsg").html(e.data.showMsg+"<br/>"+t);var a=e.data.isEnableGetIpFromInfo,o="N/A",n=e.data.location,i=e.data.countryCode,l=e.data.countryQueryURL;a?(o=""!=n&&null!=n&&"undefined"!=n?'<span class="flag-icon flag-icon-'+i+'"></span>&nbsp;'+n:'<a href="'+l+'" target="_blank">查詢IP來源國家</a>',$("#viewIpMappingPortModal_country").html(o)):$("#viewIpMappingPortModal_country").parent().hide(),$("#viewIpMappingPortModal").modal("show")}else alert(e.message)},error:function(e,t,r){ajaxErrorHandler()}})}function findData(e){$("#queryFrom").val(e),0!=$("#queryDateBegin").val().trim().length?0!=$("#query_SourceIp").val().trim().length||0!=$("#query_DestinationIp").val().trim().length||0!=$("#query_SourcePort").val().trim().length||0!=$("#query_DestinationPort").val().trim().length||0!=$("#queryGroup").val().trim().length?("MOBILE"==e&&$("#collapseExample").collapse("hide"),startNum=0,"undefined"!=typeof resultTable?($(".dataTables_scrollBody").scrollTop(0),resultTable.ajax.reload(),$(".myTableSection").show()):($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!1,bFilter:!1,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:pageLength,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(e,t,r){},ajax:{url:_ctx+"/plugin/module/netFlowTrace/getNetFlowData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?(e.queryGroup=$("#queryGroup").val(),e.querySourceIp=$("#query_SourceIp").val(),e.queryDestinationIp=$("#query_DestinationIp").val(),e.querySenderIp=$("#query_SenderIp").val(),e.querySourcePort=$("#query_SourcePort").val(),e.queryDestinationPort=$("#query_DestinationPort").val(),e.queryDateBegin=$("#queryDateBegin").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()):"MOBILE"==$("#queryFrom").val()&&(e.queryGroup=$("#queryGroup_mobile").val(),e.querySourceIp=$("#query_SourceIp_mobile").val(),e.queryDestinationIp=$("#query_DestinationIp_mobile").val(),e.querySenderIp=$("#query_SenderIp_mobile").val(),e.querySourcePort=$("#query_SourcePort_mobile").val(),e.queryDestinationPort=$("#query_DestinationPort_mobile").val(),e.queryDateBegin=$("#queryDateBegin_mobile").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()),e.start=0,e.length=pageLength,e},beforeSend:function(){countDown("START")},complete:function(){countDown("STOP")},error:function(e,t,r){ajaxErrorHandler()},timeout:1e3*parseInt(_timeout)},order:[[2,"desc"]],initComplete:function(e,t){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg)),$("#resultTable_filter").find("input").prop("placeholder","(模糊查詢速度較慢)"),getTotalTraffic(),getTotalFilteredCount(),bindScrollEvent()},drawCallback:function(e){$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),startNum=pageLength,lastScrollYPos=$(".dataTables_scrollBody").prop("scrollTop"),bindTrEvent()},columns:[{},{data:"groupName",orderable:!1},{data:"fromDateTime",orderable:!1},{},{data:"sourcePort",orderable:!1},{data:"sourceMAC",orderable:!1},{},{data:"destinationPort",orderable:!1},{data:"destinationMAC",orderable:!1},{data:"size",orderable:!1},{data:"session",orderable:!1},{data:"protocol",orderable:!1},{data:"inboundInterface",orderable:!1},{data:"outboundInterface",orderable:!1},{data:"nextHop",orderable:!1}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(e,t,r,a){return a.row+a.settings._iDisplayStart+1}},{targets:[3],className:"left",searchable:!1,orderable:!1,render:function(e,t,r){return'<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.sourceIPInGroup+"','"+r.groupName+"','"+r.sourceIP+"')\">"+r.sourceIP+"</a>"}},{targets:[6],className:"left",searchable:!1,orderable:!1,render:function(e,t,r){return'<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.destinationIPInGroup+"','"+r.groupName+"','"+r.destinationIP+"')\">"+r.destinationIP+"</a>"}}]}))):alert(msg_chooseIp):alert(msg_chooseDate)}$(document).ready(function(){initMenuStatus("toggleMenu_prtg","toggleMenu_prtg_items","cm_netflowtrace"),startNum=0,pageLength=Number($("#pageLength").val()),$("input").val("");new Cleave(".input-port-src",{numericOnly:!0,blocks:[5]}),new Cleave(".input-port-dest",{numericOnly:!0,blocks:[5]});$("#resultTable").on("xhr.dt",function(e,t,r,a){null!=r.msg&&($(".myTableSection").hide(),alert(r.msg))}),$("#query_SourceIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_DestinationIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_SenderIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_SourcePort").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_DestinationPort").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())});var e=new Date,t=e.getFullYear(),r=parseInt(e.getMonth())+1;r=r<10?"0".concat(r):r;var a=e.getDate();a=a<10?"0".concat(a):a,$("#queryDateBegin").val(t+"-"+r+"-"+a),$("#queryTimeBegin").val("00:00"),$("#queryTimeEnd").val("23:59")});var timer,startTime,timer_start,timer_end,startNum,pageLength,waitForNextData=!1,lastScrollYPos=0;function doDataExport(e){var t=new Object;"WEB"==$("#queryFrom").val()?(t.queryGroup=$("#queryGroup").val(),t.querySourceIp=$("#query_SourceIp").val(),t.queryDestinationIp=$("#query_DestinationIp").val(),t.querySenderIp=$("#query_SenderIp").val(),t.querySourcePort=$("#query_SourcePort").val(),t.queryDestinationPort=$("#query_DestinationPort").val(),t.queryDateBegin=$("#queryDateBegin").val(),t.queryTimeBegin=$("#queryTimeBegin").val(),t.queryTimeEnd=$("#queryTimeEnd").val()):"MOBILE"==$("#queryFrom").val()&&(t.queryGroup=$("#queryGroup_mobile").val(),t.querySourceIp=$("#query_SourceIp_mobile").val(),t.queryDestinationIp=$("#query_DestinationIp_mobile").val(),t.querySenderIp=$("#query_SenderIp_mobile").val(),t.querySourcePort=$("#query_SourcePort_mobile").val(),t.queryDestinationPort=$("#query_DestinationPort_mobile").val(),t.queryDateBegin=$("#queryDateBegin_mobile").val(),t.queryTimeBegin=$("#queryTimeBegin").val(),t.queryTimeEnd=$("#queryTimeEnd").val()),t.start=0,t.length=pageLength,t.searchValue=$("#resultTable_filter").find("input").val(),t.exportRecordCount=e,$.ajax({url:_ctx+"/plugin/module/netFlowTrace/dataExport.json",data:t,type:"POST",dataType:"json",async:!0,beforeSend:function(e){showProcessing()},complete:function(){hideProcessing()},initComplete:function(e,t){},success:function(e){if(200==e.code){const t=e.data.fileId,r=getResourceDownloadLink(t);location.href=r,closeExportPanel()}else alert(e.message)},error:function(e,t,r){ajaxErrorHandler()}})}function countDown(e){if("START"==e)startTime=parseInt(_timeout)-1,timer_start=performance.now(),timer=setInterval(function(){$("#timeoutMsg").val("Timeout倒數 : "+startTime+" 秒"),startTime--},1e3);else{timer_end=performance.now();var t=(parseInt(timer_end)-parseInt(timer_start))/1e3;$("#timeoutMsg").val("查詢花費時間 : "+t+" 秒"),clearInterval(timer)}}function bindScrollEvent(){$(".dataTables_scrollBody").scroll(function(e){if(0==$(".dataTables_empty").length){var t=$("#resultTable > tBody > tr").length,r=$(this).prop("scrollTop"),a=$(this).prop("scrollHeight")-$(this).prop("clientHeight");r>lastScrollYPos&&(lastScrollYPos=r,t>=pageLength&&r>=a-100&&(waitForNextData||(waitForNextData=!0,findNextData())))}})}function unbindScrollEvent(){$(".dataTables_scrollBody").off("scroll")}function addRow(e){for(var t=0;t<e.length;t++){var r=e[t],a=$("#resultTable > tBody > tr").length,o=$("#resultTable > tbody > tr:eq(0)").clone();$(o).find("td:eq(0)").html(++a),$(o).find("td:eq(1)").html(r.groupName),$(o).find("td:eq(2)").html(r.fromDateTime),$(o).find("td:eq(3)").html('<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.sourceIPInGroup+"','"+r.groupName+"','"+r.sourceIP+"')\">"+r.sourceIP+"</a>"),$(o).find("td:eq(4)").html(r.sourcePort),$(o).find("td:eq(5)").html(r.sourceMAC),$(o).find("td:eq(6)").html('<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.destinationIPInGroup+"','"+r.groupName+"','"+r.destinationIP+"')\">"+r.destinationIP+"</a>"),$(o).find("td:eq(7)").html(r.destinationPort),$(o).find("td:eq(8)").html(r.destinationMAC),$(o).find("td:eq(9)").html(r.size),$(o).find("td:eq(10)").html(r.session),$(o).find("td:eq(11)").html(r.protocol),$(o).find("td:eq(12)").html(r.inboundInterface),$(o).find("td:eq(13)").html(r.outboundInterface),$(o).find("td:eq(14)").html(r.nextHop),$("#resultTable > tbody").append($(o))}$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust()}function getTotalTraffic(){$("#div_TotalFlow").css("display","contents"),$.ajax({url:_ctx+"/plugin/module/netFlowTrace/getTotalTraffic.json",data:{queryGroup:$("#queryGroup").val(),querySourceIp:$("#query_SourceIp").val(),queryDestinationIp:$("#query_DestinationIp").val(),querySenderIp:$("#query_SenderIp").val(),querySourcePort:$("#query_SourcePort").val(),queryDestinationPort:$("#query_DestinationPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),searchValue:$("#resultTable_filter").find("input").val()},type:"POST",dataType:"json",async:!0,beforeSend:function(e){$("#result_TotalFlow").text("總流量："),$("#searchWaiting").show()},complete:function(){$("#searchWaiting").hide()},initComplete:function(e,t){},success:function(e){var t=e.data.TTL_TRAFFIC;"EMPTY"===t?$("#result_TotalFlow").text("查無符合資料"):$("#result_TotalFlow").text("總流量："+t)},error:function(e,t,r){$("#result_TotalFlow").text("查無符合資料")}})}function getTotalFilteredCount(){$.ajax({url:_ctx+"/plugin/module/netFlowTrace/getTotalFilteredCount.json",data:{queryGroup:$("#queryGroup").val(),querySourceIp:$("#query_SourceIp").val(),queryDestinationIp:$("#query_DestinationIp").val(),querySenderIp:$("#query_SenderIp").val(),querySourcePort:$("#query_SourcePort").val(),queryDestinationPort:$("#query_DestinationPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),searchValue:$("#resultTable_filter").find("input").val()},type:"POST",dataType:"json",async:!0,beforeSend:function(e){var t,r;0==$(".dataTables_empty").length?(t=1,r=$("#resultTable > tBody > tr").length):(t=0,r=0),$("#resultTable_info").html('<div class="row" style="padding-left: 15px;"><div id="current_count">顯示第 '+t+" 至 "+r+' 項結果，共</div><div id="total_count"><img id="searchWaiting2" class="img_searchWaiting" alt="loading..." src="/resources/images/Processing_4.gif"></div><div style="">筆</div></div>')},complete:function(){$("#searchWaiting2").hide()},initComplete:function(e,t){},success:function(e){var t=e.data.FILTERED_COUNT;$("#total_count").html("&nbsp;"+t+"&nbsp;")},error:function(e,t,r){$("#total_count").html("&nbsp;N/A&nbsp;")}})}function findNextData(){var e,t=-1;$(".dataTable > thead").find(".sorting_asc").length>0?t=$(".dataTable > thead").find(".sorting_asc").prop("cellIndex"):$(".dataTable > thead").find(".sorting_desc").length>0&&(t=$(".dataTable > thead").find(".sorting_desc").prop("cellIndex")),e="descending"===$(".dataTable > thead > tr > th:eq("+t+")").attr("aria-sort")?"desc":"asc",$.ajax({url:_ctx+"/plugin/module/netFlowTrace/getNetFlowData.json",data:{queryGroup:$("#queryGroup").val(),querySourceIp:$("#query_SourceIp").val(),queryDestinationIp:$("#query_DestinationIp").val(),querySenderIp:$("#query_SenderIp").val(),querySourcePort:$("#query_SourcePort").val(),queryDestinationPort:$("#query_DestinationPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),start:startNum,length:pageLength,searchValue:$("#resultTable_filter").find("input").val(),"order[0][column]":t,"order[0][dir]":e},type:"POST",dataType:"json",async:!0,beforeSend:function(e){countDown("START"),showProcessing()},complete:function(){countDown("STOP"),hideProcessing(),waitForNextData=!1},initComplete:function(e,t){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg))},success:function(e){var t,r,a=e.data.length;console.log("query success... count: "+a),a>0&&(addRow(e.data),startNum+=pageLength),0==$(".dataTables_empty").length?(t=1,r=$("#resultTable > tBody > tr").length):(t=0,r=0),$("#current_count").text("顯示第 "+t+" 至 "+r+" 項結果，共")},error:function(e,t,r){$("#current_count").text("<ERROR>"),ajaxErrorHandler()}})}function viewIpPort(e,t,r,a,o){var n=new Object;n.groupId=e,n.fromDateTime=t,n.groupName=a,n.ipAddress=o,$.ajax({url:_ctx+"/plugin/module/ipTracePoller/getIpTraceDataFromNetFlow.json",data:JSON.stringify(n),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(e){if("200"==e.code){var t="";$("#viewIpMappingPortModal_groupName").parent().show(),"Y"==r?($("#viewIpMappingPortModal_deviceName").parent().show(),$("#viewIpMappingPortModal_deviceModel").parent().show(),$("#viewIpMappingPortModal_portName").parent().show(),$("#viewIpMappingPortModal_country").parent().hide(),t="IP is in the group subnet"):($("#viewIpMappingPortModal_deviceName").parent().hide(),$("#viewIpMappingPortModal_deviceModel").parent().hide(),$("#viewIpMappingPortModal_portName").parent().hide(),$("#viewIpMappingPortModal_country").parent().show(),t="IP is not in the group subnet"),$("#viewIpMappingPortModal_ipAddress").parent().show(),$("#viewIpMappingPortModal_ipDesc").parent().show(),$("#viewIpMappingPortModal_showMsg").parent().show(),$("#viewIpMappingPortModal_groupName").html(e.data.groupName),$("#viewIpMappingPortModal_deviceName").html(e.data.deviceName),$("#viewIpMappingPortModal_deviceModel").html(e.data.deviceModel),$("#viewIpMappingPortModal_ipAddress").html(e.data.ipAddress),$("#viewIpMappingPortModal_ipDesc").html(e.data.ipDesc),$("#viewIpMappingPortModal_portName").html(e.data.portName),$("#viewIpMappingPortModal_showMsg").html(e.data.showMsg+"<br/>"+t);var a=e.data.isEnableGetIpFromInfo,o="N/A",n=e.data.location,i=e.data.countryCode,l=e.data.countryQueryURL;a?(o=""!=n&&null!=n&&"undefined"!=n?'<span class="flag-icon flag-icon-'+i+'"></span>&nbsp;'+n:'<a href="'+l+'" target="_blank">查詢IP來源國家</a>',$("#viewIpMappingPortModal_country").html(o)):$("#viewIpMappingPortModal_country").parent().hide(),$("#viewIpMappingPortModal").modal("show")}else alert(e.message)},error:function(e,t,r){ajaxErrorHandler()}})}function findData(e){$("#queryFrom").val(e),0!=$("#queryDateBegin").val().trim().length?0!=$("#query_SourceIp").val().trim().length||0!=$("#query_DestinationIp").val().trim().length||0!=$("#query_SourcePort").val().trim().length||0!=$("#query_DestinationPort").val().trim().length||0!=$("#queryGroup").val().trim().length?("MOBILE"==e&&$("#collapseExample").collapse("hide"),startNum=0,"undefined"!=typeof resultTable?($(".dataTables_scrollBody").scrollTop(0),resultTable.ajax.reload(),$(".myTableSection").show()):($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!1,bFilter:!1,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:pageLength,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(e,t,r){},ajax:{url:_ctx+"/plugin/module/netFlowTrace/getNetFlowData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?(e.queryGroup=$("#queryGroup").val(),e.querySourceIp=$("#query_SourceIp").val(),e.queryDestinationIp=$("#query_DestinationIp").val(),e.querySenderIp=$("#query_SenderIp").val(),e.querySourcePort=$("#query_SourcePort").val(),e.queryDestinationPort=$("#query_DestinationPort").val(),e.queryDateBegin=$("#queryDateBegin").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()):"MOBILE"==$("#queryFrom").val()&&(e.queryGroup=$("#queryGroup_mobile").val(),e.querySourceIp=$("#query_SourceIp_mobile").val(),e.queryDestinationIp=$("#query_DestinationIp_mobile").val(),e.querySenderIp=$("#query_SenderIp_mobile").val(),e.querySourcePort=$("#query_SourcePort_mobile").val(),e.queryDestinationPort=$("#query_DestinationPort_mobile").val(),e.queryDateBegin=$("#queryDateBegin_mobile").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()),e.start=0,e.length=pageLength,e},beforeSend:function(){countDown("START")},complete:function(){countDown("STOP")},error:function(e,t,r){ajaxErrorHandler()},timeout:1e3*parseInt(_timeout)},order:[[2,"desc"]],initComplete:function(e,t){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg)),$("#resultTable_filter").find("input").prop("placeholder","(模糊查詢速度較慢)"),getTotalTraffic(),getTotalFilteredCount(),bindScrollEvent()},drawCallback:function(e){$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),startNum=pageLength,lastScrollYPos=$(".dataTables_scrollBody").prop("scrollTop"),bindTrEvent()},columns:[{},{data:"groupName",orderable:!1},{data:"fromDateTime",orderable:!1},{},{data:"sourcePort",orderable:!1},{data:"sourceMAC",orderable:!1},{},{data:"destinationPort",orderable:!1},{data:"destinationMAC",orderable:!1},{data:"size",orderable:!1},{data:"session",orderable:!1},{data:"protocol",orderable:!1},{data:"inboundInterface",orderable:!1},{data:"outboundInterface",orderable:!1},{data:"nextHop",orderable:!1}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(e,t,r,a){return a.row+a.settings._iDisplayStart+1}},{targets:[3],className:"left",searchable:!1,orderable:!1,render:function(e,t,r){return'<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.sourceIPInGroup+"','"+r.groupName+"','"+r.sourceIP+"')\">"+r.sourceIP+"</a>"}},{targets:[6],className:"left",searchable:!1,orderable:!1,render:function(e,t,r){return'<a href="#" onclick="viewIpPort(\''+r.groupId+"','"+r.fromDateTime+"','"+r.destinationIPInGroup+"','"+r.groupName+"','"+r.destinationIP+"')\">"+r.destinationIP+"</a>"}}]}))):alert(msg_chooseIp):alert(msg_chooseDate)}$(document).ready(function(){initMenuStatus("toggleMenu_prtg","toggleMenu_prtg_items","cm_netflowtrace"),startNum=0,pageLength=Number($("#pageLength").val()),$("input").val("");new Cleave(".input-port-src",{numericOnly:!0,blocks:[5]}),new Cleave(".input-port-dest",{numericOnly:!0,blocks:[5]});$("#resultTable").on("xhr.dt",function(e,t,r,a){null!=r.msg&&($(".myTableSection").hide(),alert(r.msg))}),$("#query_SourceIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_DestinationIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_SenderIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_SourcePort").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_DestinationPort").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())});var e=new Date,t=e.getFullYear(),r=parseInt(e.getMonth())+1;r=r<10?"0".concat(r):r;var a=e.getDate();a=a<10?"0".concat(a):a,$("#queryDateBegin").val(t+"-"+r+"-"+a),$("#queryTimeBegin").val("00:00"),$("#queryTimeEnd").val("23:59")});