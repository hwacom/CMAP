var startNum,pageLength,resultTable2;function bindScrollEvent(){$(".dataTables_scrollBody").scroll(function(e){if(0==$(".dataTables_empty").length){var a=$("#resultTable > tBody > tr").length,t=$(this).prop("scrollTop"),r=$(this).prop("scrollHeight")-$(this).prop("clientHeight");t>lastScrollYPos&&(lastScrollYPos=t,a>=pageLength&&t>=r-100&&(waitForNextData||(waitForNextData=!0,findNextData())))}})}function unbindScrollEvent(){$(".dataTables_scrollBody").off("scroll")}function countDown(e){if("START"==e)startTime=parseInt(_timeout)-1,timer_start=performance.now(),timer=setInterval(function(){$("#timeoutMsg").val("Timeout倒數 : "+startTime+" 秒"),startTime--},1e3);else{timer_end=performance.now();var a=(parseInt(timer_end)-parseInt(timer_start))/1e3;$("#timeoutMsg").val("查詢花費時間 : "+a+" 秒"),clearInterval(timer)}}function getTotalFilteredCount(){$.ajax({url:_ctx+"/plugin/module/alarmSummary/getTotalFilteredCount.json",data:{queryDateBegin:$("#queryDateBegin").val(),queryDateEnd:$("#queryDateEnd").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),querySensorType:$("#querySensorType").val(),queryStatus:$("#queryStatus").val(),queryDataStatus:"active",queryMessage:$("#queryMessage").val()},type:"POST",dataType:"json",async:!0,beforeSend:function(e){var a,t;0==$(".dataTables_empty").length?(a=1,t=$("#resultTable > tBody > tr").length):(a=0,t=0),$("#resultTable_info").html('<div class="row" style="padding-left: 15px;"><div id="current_count">顯示第 '+a+" 至 "+t+' 項結果，共</div><div id="total_count"><img id="searchWaiting2" class="img_searchWaiting" alt="loading..." src="/resources/images/Processing_4.gif"></div><div style="">筆</div></div>')},complete:function(){$("#searchWaiting2").hide()},initComplete:function(e,a){},success:function(e){var a=e.data.FILTERED_COUNT;$("#total_count").html("&nbsp;"+a+"&nbsp;")},error:function(e,a,t){$("#total_count").html("&nbsp;N/A&nbsp;")}})}function findData(e){$("#queryFrom").val(e),0!=$("#queryDateBegin").val().trim().length&&0!=$("#queryDateEnd").val().trim().length?("MOBILE"==e&&$("#collapseExample").collapse("hide"),$("div .show").attr("id").endsWith("tab2")?findHistoryData():"undefined"!=typeof resultTable?($(".dataTables_scrollBody").scrollTop(0),resultTable.ajax.reload()):resultTable=$("#resultTable").DataTable({autoWidth:!0,ordering:!0,info:!0,bLengthChange:!0,processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:pageLength,search:{caseInsensitive:!0},dom:"Bfrtip",buttons:[{extend:"copy",text:'<i class="fas fa-copy"></i>複製至剪貼簿',titleAttr:"複製至剪貼簿",className:"btn btn-sm btn-primary ml-2"},{extend:"excel",text:'<i class="fas fa-file-excel"></i>匯出xlsx',titleAttr:"匯出xlsx",className:"btn btn-sm btn-primary ml-2"},{extend:"csv",text:'<i class="fas fa-file-csv"></i>匯出csv',titleAttr:"匯出csv",className:"btn btn-sm btn-primary ml-2"},{extend:"pdf",text:'<i class="fas fa-file-pdf"></i> PDF',className:"btn btn-sm btn-primary ml-2"},{extend:"print",text:'<i class="fas fa-print"></i> Print',titleAttr:"列印",className:"btn btn-sm btn-primary ml-2"},{extend:"colvis",text:"欄位選擇",collectionLayout:"fixed two-column",columns:":gt(0)"},{text:"Get selected data",action:function(){if(0!=resultTable.rows({selected:!0}).count()){var e=resultTable.rows({selected:!0}).data(),a=[];for(i=0;i<e.length;i++)a.push(e[i].alarmId);return console.log(a)}}}],language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(e,a,t){},ajax:{url:_ctx+"/plugin/module/alarmSummary/getAlarmData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?(e.queryDateBegin=$("#queryDateBegin").val(),e.queryDateEnd=$("#queryDateEnd").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val(),e.querySensorType=$("#querySensorType").val(),e.queryStatus=$("#queryStatus").val(),e.queryDataStatus="active",e.queryMessage=$("#queryMessage").val()):"MOBILE"==$("#queryFrom").val()&&(e.queryDateBegin=$("#queryDateBegin_mobile").val(),e.queryDateEnd=$("#queryDateEnd_mobile").val()),e.start=0,e.length=pageLength,e},beforeSend:function(){countDown("START")},complete:function(){countDown("STOP")},error:function(e,a,t){ajaxErrorHandler()},timeout:1e3*parseInt(_timeout)},order:[[6,"desc"]],initComplete:function(e,a){null!=a.msg&&alert(a.msg)},drawCallback:function(e){startNum=pageLength,lastScrollYPos=$(".dataTables_scrollBody").prop("scrollTop"),$("#resultTable_filter").find("input").prop("placeholder","(模糊查詢速度較慢)"),bindTrEvent()},columns:[{data:function(e,a,t){return""}},{},{data:"sensorType",className:"center",orderable:!1},{data:"groupName",className:"center",orderable:!1},{data:"deviceName",className:"center",orderable:!1},{data:"alarmStatus",className:"center",orderable:!1},{data:"alarmTimeStr",className:"center",orderable:!1},{data:"closeTimeStr",className:"center",orderable:!1},{data:"lastValue",className:"center",orderable:!1},{data:"message",className:"center",orderable:!1},{data:"priority",className:"center",orderable:!1},{data:"remark",orderable:!1},{}],select:{style:"multi"},columnDefs:[{orderable:!1,className:"select-checkbox",targets:0},{targets:[1],className:"center",searchable:!1,orderable:!1,render:function(e,a,t,r){return'<a href="#" onclick="alarmDialog(\''+t.sensorName+"', '"+t.groupName+"', '"+t.deviceName+"', '"+t.sensorType+"', '"+t.alarmStatus+"', '"+t.alarmTimeStr+"', '"+t.lastValue+"', '"+t.message+"', '"+t.priority+"', '"+t.remark+'\')"><span data-feather="zoom-in"></span>'+t.sensorName+"</a>"}},{targets:[12],className:"center",searchable:!1,orderable:!1,render:function(e,a,t){return'<i class="fas fa-clipboard-list fa-lg" onclick="showLogDialog('+t.alarmId+')" ></i>'}}]})):alert(msg_chooseDate)}function findHistoryData(){void 0!==resultTable2?($(".dataTables_scrollBody").scrollTop(0),resultTable2.ajax.reload()):(resultTable2=$("#resultTable2").DataTable({autoWidth:!0,ordering:!0,info:!0,bLengthChange:!0,processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:pageLength,search:{caseInsensitive:!0},dom:"Bfrtip",buttons:[{extend:"copy",text:'<i class="fas fa-copy"></i>複製至剪貼簿',titleAttr:"複製至剪貼簿",className:"btn btn-sm btn-primary ml-2"},{extend:"excel",text:'<i class="fas fa-file-excel"></i>匯出xlsx',titleAttr:"匯出xlsx",className:"btn btn-sm btn-primary ml-2"},{extend:"csv",text:'<i class="fas fa-file-csv"></i>匯出csv',titleAttr:"匯出csv",className:"btn btn-sm btn-primary ml-2"},{extend:"pdf",text:'<i class="fas fa-file-pdf"></i> PDF',className:"btn btn-sm btn-primary ml-2"},{extend:"print",text:'<i class="fas fa-print"></i> Print',titleAttr:"列印",className:"btn btn-sm btn-primary ml-2"},{extend:"colvis",text:"欄位選擇",collectionLayout:"fixed two-column",columns:":gt(0)"},{text:"Get selected data",action:function(){if(0!=resultTable2.rows({selected:!0}).count()){var e=resultTable2.rows({selected:!0}).data(),a=[];for(i=0;i<e.length;i++)a.push(e[i].alarmId);return console.log(a)}}}],language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(e,a,t){},ajax:{url:_ctx+"/plugin/module/alarmSummary/getAlarmData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?(e.queryDateBegin=$("#queryDateBegin").val(),e.queryDateEnd=$("#queryDateEnd").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val(),e.querySensorType=$("#querySensorType").val(),e.queryStatus=$("#queryStatus").val(),e.queryDataStatus="history",e.queryMessage=$("#queryMessage").val()):"MOBILE"==$("#queryFrom").val()&&(e.queryDateBegin=$("#queryDateBegin_mobile").val(),e.queryDateEnd=$("#queryDateEnd_mobile").val()),e.start=0,e.length=pageLength,e},beforeSend:function(){countDown("START")},complete:function(){countDown("STOP")},error:function(e,a,t){ajaxErrorHandler()},timeout:1e3*parseInt(_timeout)},order:[[6,"desc"]],initComplete:function(e,a){null!=a.msg&&alert(a.msg)},drawCallback:function(e){startNum=pageLength,lastScrollYPos=$(".dataTables_scrollBody").prop("scrollTop"),$("#resultTable2_filter").find("input").prop("placeholder","(模糊查詢速度較慢)")},columns:[{data:function(e,a,t){return""}},{},{data:"sensorType",className:"center",orderable:!1},{data:"groupName",className:"center",orderable:!1},{data:"deviceName",className:"center",orderable:!1},{data:"alarmStatus",className:"center",orderable:!1},{data:"alarmTimeStr",className:"center",orderable:!1},{data:"closeTimeStr",className:"center",orderable:!1},{data:"lastValue",className:"center",orderable:!1},{data:"message",className:"center",orderable:!1},{data:"priority",className:"center",orderable:!1},{data:"remark",orderable:!1},{}],select:{style:"multi"},columnDefs:[{orderable:!1,className:"select-checkbox",targets:0},{targets:[1],className:"center",searchable:!1,orderable:!1,render:function(e,a,t,r){return'<a href="#" onclick="alarmDialog(\''+t.sensorName+"', '"+t.groupName+"', '"+t.deviceName+"', '"+t.sensorType+"', '"+t.alarmStatus+"', '"+t.alarmTimeStr+"', '"+t.lastValue+"', '"+t.message+"', '"+t.priority+"', '"+t.remark+'\')"><span data-feather="zoom-in"></span>'+t.sensorName+"</a>"}},{targets:[12],className:"center",searchable:!1,orderable:!1,render:function(e,a,t){return'<i class="fas fa-clipboard-list fa-lg" onclick="showLogDialog('+t.alarmId+')" ></i>'}}]}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){$($.fn.dataTable.tables(!0)).DataTable().columns.adjust()}))}function showLogDialog(e){var a=new Object;$(".alarmLogTitle").text(e),a.alarmId=e,$.ajax({url:_ctx+"/plugin/module/alarmSummary/getAlarmLog.json",data:JSON.stringify(a),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(e){if("200"==e.code){document.getElementById("alarmLogDiv").remove();var a=document.getElementById("alarmLogBody"),t=document.createElement("div");t.setAttribute("id","alarmLogDiv"),t.setAttribute("class","form-group row"),t.innerHTML=e.message,a.appendChild(t),$("#alarmLogDialogModal").modal({backdrop:"static"})}else alert(e.message)},error:function(e,a,t){ajaxErrorHandler()}})}function doActionAjax(e,a){$.ajax({url:_ctx+"/plugin/module/alarmSummary/"+a,data:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(e){"200"==e.code?(setTimeout(function(){$("#updateStatusDialogModal").modal("hide")},500),alert(e.message),resultTable.ajax.reload()):alert(e.message)},error:function(e,a,t){ajaxErrorHandler()}})}function addNewTicket(){var e=new Object,a=[];if($("div .show").attr("id").endsWith("tab1")){a=resultTable.rows({selected:!0}).data();var t=[];for(i=0;i<a.length;i++)t.push(a[i].alarmId);e.ids=t,e.updateStatus="doing",e.inputOwner=$("#inputOwner option:selected")[0].parentNode.label+"-"+$("#inputOwner").val(),setTimeout(function(){$("#addNewTicketDialogModal").modal("hide")},500),$.ajax({url:_ctx+"/plugin/module/alarmSummary/addNewTicket",data:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(e){"200"==e.code?(alert(e.message),setTimeout(function(){location.href="tickets"},750)):alert(e.message)},error:function(e,a,t){ajaxErrorHandler()}})}else alert("已封存項目不可開立工單!!")}function alarmDialog(e,a,t,r,l,s,n,o,i,c){$(".alarmTitle").text(a+"-"+t+"\t"+e),$(".alarmPriority").text(i),$(".alarmSensorType").text(r),$(".alarmStatus").text(l),$(".alarmTimeStr").text(s),$(".alarmLastValue").text(n),$(".alarmTimeStr").text(o),$(".alarmMessage").text(i),$(".alarmRemark").text(c),$("#alarmDialogModal").modal({backdrop:"static"})}function doDataExport(e){var a=new Object;a.queryDateBegin=$("#queryDateBegin").val(),a.queryDateEnd=$("#queryDateEnd").val(),a.queryTimeBegin=$("#queryTimeBegin").val(),a.queryTimeEnd=$("#queryTimeEnd").val(),a.queryStatus=$("#queryStatus").val(),a.queryMessage=$("#queryMessage").val(),a.start=0,a.length=pageLength,a.exportRecordCount=e,$.ajax({url:_ctx+"/plugin/module/alarmSummary/dataExport.json",data:a,type:"POST",dataType:"json",async:!0,beforeSend:function(e){showProcessing()},complete:function(){hideProcessing()},initComplete:function(e,a){},success:function(e){if(200==e.code){const a=e.data.fileId,t=getResourceDownloadLink(a);location.href=t,closeExportPanel()}else alert(e.message)},error:function(e,a,t){ajaxErrorHandler()}})}$(document).ready(function(){initMenuStatus("toggleMenu_abnormalAlarm_items","toggleMenu_abnormalAlarm_items","mp_alarmSummary2"),startNum=0,pageLength=Number($("#pageLength").val());var e=new Date,a=e.getFullYear(),t=parseInt(e.getMonth())+1;t=t<10?"0".concat(t):t;var r=e.getDate(),l=a+"-"+t+"-"+(r=r<10?"0".concat(r):r);$("#queryDateEnd").val(l),$("#queryTimeBegin").val("00:00"),$("#queryTimeEnd").val("23:59"),e.setDate(e.getDate()-6),l=a+"-"+t+"-"+(r=(r=e.getDate())<10?"0".concat(r):r),$("#queryDateBegin").val(l),1==$("#btnSearch_web").length&&$("div .show").attr("id").endsWith("tab1")&&findData(isWEB?"WEB":"MOBILE"),$("#btnUpdateStatus").click(function(e){0!=($("div .show").attr("id").endsWith("tab1")?resultTable.rows({selected:!0}).count():resultTable2.rows({selected:!0}).count())?$("#updateStatusDialogModal").modal({backdrop:"static"}):alert("請先勾選欲執行的項目!")}),$("#btnConfirmUpdate").click(function(){var e=new Object,a=[];a=$("div .show").attr("id").endsWith("tab1")?resultTable.rows({selected:!0}).data():resultTable2.rows({selected:!0}).data();var t=[];for(i=0;i<a.length;i++)t.push(a[i].alarmId);if("doing"==$("#updateStatus").val())return t.length>1?void alert("開立工單請僅勾選1個項目!!"):"doing"==a[0].alarmDataStatus?void alert("此警報已開立工單!!"):(setTimeout(function(){$("#updateStatusDialogModal").modal("hide")},500),void $("#addNewTicketDialogModal").modal({backdrop:"static"}));e.ids=t,e.updateStatus=$("#updateStatus").val(),doActionAjax(e,"updateStatus")}),$("#btnConfirmCreate").click(function(){confirm("請確認是否新增?","addNewTicket")}),$("#chkAllBox1").click(function(){$("#resultTable th.select-checkbox").hasClass("selected")?(resultTable.rows().deselect(),$("#resultTable th.select-checkbox").removeClass("selected"),$("#chkAllBox1").prop("checked",!1)):(resultTable.rows().select(),$("#resultTable th.select-checkbox").addClass("selected"),$("#chkAllBox1").prop("checked",!0))}).on("select deselect",function(){resultTable.rows({selected:!0}).count()!==resultTable.rows().count()?$("#resultTable th.select-checkbox").removeClass("selected"):$("#resultTable th.select-checkbox").addClass("selected")}),$("#chkAllBox2").click(function(){$("#resultTable2 th.select-checkbox").hasClass("selected")?(resultTable2.rows().deselect(),$("#resultTable2 th.select-checkbox").removeClass("selected"),$("#chkAllBox2").prop("checked",!1)):(resultTable2.rows().select(),$("#resultTable2 th.select-checkbox").addClass("selected"),$("#chkAllBox2").prop("checked",!0))}).on("select deselect",function(){resultTable2.rows({selected:!0}).count()!==resultTable2.rows().count()?$("#resultTable2 th.select-checkbox").removeClass("selected"):$("#resultTable2 th.select-checkbox").addClass("selected")})});