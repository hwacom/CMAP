var timer,startTime,timer_start,timer_end,startNum,pageLength,waitForNextData=!1,lastScrollYPos=0;function countDown(e){if("START"==e)startTime=parseInt(_timeout)-1,timer_start=performance.now(),timer=setInterval(function(){$("#timeoutMsg").val("Timeout倒數 : "+startTime+" 秒"),startTime--},1e3);else{timer_end=performance.now();var a=(parseInt(timer_end)-parseInt(timer_start))/1e3;$("#timeoutMsg").val("查詢花費時間 : "+a+" 秒"),clearInterval(timer)}}function bindScrollEvent(){$(".dataTables_scrollBody").scroll(function(e){if(0==$(".dataTables_empty").length){var a=$("#resultTable > tBody > tr").length,t=$(this).prop("scrollTop"),d=$(this).prop("scrollHeight")-$(this).prop("clientHeight");t>lastScrollYPos&&(lastScrollYPos=t,a>=pageLength&&t>=d-100&&(waitForNextData||(waitForNextData=!0,findNextData())))}})}function unbindScrollEvent(){$(".dataTables_scrollBody").off("scroll")}function findNextData(){var e,a=-1;$(".dataTable > thead").find(".sorting_asc").length>0?a=$(".dataTable > thead").find(".sorting_asc").prop("cellIndex"):$(".dataTable > thead").find(".sorting_desc").length>0&&(a=$(".dataTable > thead").find(".sorting_desc").prop("cellIndex")),e="descending"===$(".dataTable > thead > tr > th:eq("+a+")").attr("aria-sort")?"desc":"asc",$.ajax({url:_ctx+"/plugin/module/firewall/log/getFirewallLogData.json",data:{queryType:$("#queryType").val(),queryDevName:$("#queryDevName").val(),querySrcIp:$("#querySrcIp").val(),querySrcPort:$("#querySrcPort").val(),queryDstIp:$("#queryDstIp").val(),queryDstPort:$("#queryDstPort").val(),queryDateBegin:$("#queryDateBegin").val(),queryDateEnd:$("#queryDateEnd").val(),queryTimeBegin:$("#queryTimeBegin").val(),queryTimeEnd:$("#queryTimeEnd").val(),start:startNum,length:pageLength,searchValue:$("#resultTable_filter").find("input").val(),"order[0][column]":a,"order[0][dir]":e},type:"POST",dataType:"json",async:!0,beforeSend:function(e){countDown("START"),showProcessing()},complete:function(){countDown("STOP"),hideProcessing(),waitForNextData=!1},initComplete:function(e,a){null!=a.msg&&($(".myTableSection").hide(),alert(a.msg))},success:function(e){var a,t;e.data.length>0&&(addRow(e.data),startNum+=pageLength),0==$(".dataTables_empty").length?(a=1,t=$("#resultTable > tBody > tr").length):(a=0,t=0),$("#current_count").text("顯示第 "+a+" 至 "+t+" 項結果，共")},error:function(e,a,t){$("#current_count").text("<ERROR>"),ajaxErrorHandler()}})}function addRow(e){for(var a=0;a<e.length;a++){var t=e[a],d=$("#resultTable > tBody > tr").length,l=$("#resultTable > tbody > tr:eq(0)").clone();$(l).find("td:eq(0)").html(++d),$(l).find("td:eq(1)").html(t.type),$(l).find("td:eq(2)").html(t.devName),$(l).find("td:eq(3)").html(t.dateStr),$(l).find("td:eq(4)").html(t.timeStr),$(l).find("td:eq(5)").html(t.severity),$(l).find("td:eq(6)").html(t.srcIp),$(l).find("td:eq(7)").html(t.srcPort),$(l).find("td:eq(8)").html(t.srcCountry),$(l).find("td:eq(9)").html(t.dstIp),$(l).find("td:eq(10)").html(t.dstPort),$(l).find("td:eq(11)").html(t.proto),$(l).find("td:eq(12)").html(t.service),$(l).find("td:eq(13)").html(t.url),$(l).find("td:eq(14)").html(t.app),$(l).find("td:eq(15)").html(t.action),$(l).find("td:eq(16)").html(t.sentByte),$(l).find("td:eq(17)").html(t.rcvdByte),$(l).find("td:eq(18)").html(t.utmAction),$(l).find("td:eq(19)").html(t.level),$(l).find("td:eq(20)").html(t.user),$(l).find("td:eq(21)").html(t.message),$(l).find("td:eq(22)").html(t.attack),$("#resultTable > tbody").append($(l))}$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust()}function getTotalFilteredCount(){var e=new Object;"WEB"==$("#queryFrom").val()?(e.queryType=$("#queryType").val(),e.queryDevName=$("#queryDevName").val(),e.querySrcIp=$("#querySrcIp").val(),e.querySrcPort=$("#querySrcPort").val(),e.queryDstIp=$("#queryDstIp").val(),e.queryDstPort=$("#queryDstPort").val(),e.queryDateBegin=$("#queryDateBegin").val(),e.queryDateEnd=$("#queryDateEnd").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()):"MOBILE"==$("#queryFrom").val()&&(e.queryType=$("#queryTypeMobile").val(),e.queryDevName=$("#queryDevNameMobile").val(),e.querySrcIp=$("#query_SrcIp_mobile").val(),e.querySrcPort=$("#query_SrcPort_mobile").val(),e.queryDstIp=$("#query_DstIp_mobile").val(),e.queryDstPort=$("#query_DstPort_mobile").val(),e.queryDateBegin=$("#queryDateBegin_mobile").val(),e.queryDateEnd=$("#queryDateEnd_mobile").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()),$.ajax({url:_ctx+"/plugin/module/firewall/log/getFirewallLogCount.json",data:e,type:"POST",dataType:"json",async:!0,beforeSend:function(e){var a,t;0==$(".dataTables_empty").length?(a=1,t=$("#resultTable > tBody > tr").length):(a=0,t=0),$("#resultTable_info").html('<div class="row" style="padding-left: 15px;"><div id="current_count">顯示第 '+a+" 至 "+t+' 項結果，共</div><div id="total_count"><img id="searchWaiting2" class="img_searchWaiting" alt="loading..." src="/resources/images/Processing_4.gif"></div><div style="">筆</div></div>')},complete:function(){$("#searchWaiting2").hide()},initComplete:function(e,a){},success:function(e){var a=e.data.FILTERED_COUNT;$("#total_count").html("&nbsp;"+a+"&nbsp;")},error:function(e,a,t){$("#total_count").html("&nbsp;N/A&nbsp;")}})}function findData(e){$("#queryFrom").val(e),0!=$("#queryDateBegin").val().trim().length?0!=$("#queryTimeBegin").val().trim().length&&0!=$("#queryTimeEnd").val().trim().length?("MOBILE"==e&&$("#collapseExample").collapse("hide"),startNum=0,"undefined"!=typeof resultTable?($(".dataTables_scrollBody").scrollTop(0),resultTable.ajax.reload(),$(".myTableSection").show()):($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!1,bFilter:!0,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:pageLength,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(e,a,t){},ajax:{url:_ctx+"/plugin/module/firewall/log/getFirewallLogData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?(e.queryType=$("#queryType").val(),e.queryDevName=$("#queryDevName").val(),e.querySrcIp=$("#querySrcIp").val(),e.querySrcPort=$("#querySrcPort").val(),e.queryDstIp=$("#queryDstIp").val(),e.queryDstPort=$("#queryDstPort").val(),e.queryDateBegin=$("#queryDateBegin").val(),e.queryDateEnd=$("#queryDateEnd").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()):"MOBILE"==$("#queryFrom").val()&&(e.queryType=$("#queryTypeMobile").val(),e.queryDevName=$("#queryDevNameMobile").val(),e.querySrcIp=$("#query_SrcIp_mobile").val(),e.querySrcPort=$("#query_SrcPort_mobile").val(),e.queryDstIp=$("#query_DstIp_mobile").val(),e.queryDstPort=$("#query_DstPort_mobile").val(),e.queryDateBegin=$("#queryDateBegin_mobile").val(),e.queryDateEnd=$("#queryDateEnd_mobile").val(),e.queryTimeBegin=$("#queryTimeBegin").val(),e.queryTimeEnd=$("#queryTimeEnd").val()),e.start=0,e.length=pageLength,e},beforeSend:function(){countDown("START")},complete:function(){countDown("STOP")},error:function(e,a,t){ajaxErrorHandler()},dataSrc:function(e){return e.data.length>0?null!=e.otherMsg&&""!=e.otherMsg&&$("#div_TotalFlow").css("display","contents"):($("#div_TotalFlow").css("display","contents"),$("#result_TotalFlow").text("查無符合資料")),e.data},timeout:1e3*parseInt(_timeout)},order:[[3,"desc"]],initComplete:function(e,a){null!=a.msg&&($(".myTableSection").hide(),alert(a.msg)),bindScrollEvent()},drawCallback:function(e){$("div.dataTables_length").parent().removeClass("col-sm-12"),$("div.dataTables_length").parent().addClass("col-sm-6"),$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),$("div.dataTables_paginate").parent().removeClass("col-sm-12"),$("div.dataTables_paginate").parent().addClass("col-sm-6"),$("[data-field]").removeClass("td-na");var a=$("#queryType").val();"APP"==a?($('[data-field="severity"]').eq(0).addClass("td-na"),$('[data-field="srcCountry"]').eq(0).addClass("td-na"),$('[data-field="service"]').eq(0).addClass("td-na"),$('[data-field="url"]').eq(0).addClass("td-na"),$('[data-field="sentByte"]').eq(0).addClass("td-na"),$('[data-field="rcvdByte"]').eq(0).addClass("td-na"),$('[data-field="utmAction"]').eq(0).addClass("td-na"),$('[data-field="level"]').eq(0).addClass("td-na"),$('[data-field="user"]').eq(0).addClass("td-na"),$('[data-field="message"]').eq(0).addClass("td-na"),$('[data-field="attack"]').eq(0).addClass("td-na")):"FORWARDING"==a?($('[data-field="severity"]').eq(0).addClass("td-na"),$('[data-field="srcCountry"]').eq(0).addClass("td-na"),$('[data-field="service"]').eq(0).addClass("td-na"),$('[data-field="url"]').eq(0).addClass("td-na"),$('[data-field="level"]').eq(0).addClass("td-na"),$('[data-field="user"]').eq(0).addClass("td-na"),$('[data-field="message"]').eq(0).addClass("td-na"),$('[data-field="attack"]').eq(0).addClass("td-na")):"SYSTEM"==a?($('[data-field="severity"]').eq(0).addClass("td-na"),$('[data-field="srcIp"]').eq(0).addClass("td-na"),$('[data-field="srcPort"]').eq(0).addClass("td-na"),$('[data-field="srcCountry"]').eq(0).addClass("td-na"),$('[data-field="dstIp"]').eq(0).addClass("td-na"),$('[data-field="dstPort"]').eq(0).addClass("td-na"),$('[data-field="proto"]').eq(0).addClass("td-na"),$('[data-field="service"]').eq(0).addClass("td-na"),$('[data-field="url"]').eq(0).addClass("td-na"),$('[data-field="app"]').eq(0).addClass("td-na"),$('[data-field="action"]').eq(0).addClass("td-na"),$('[data-field="sentByte"]').eq(0).addClass("td-na"),$('[data-field="rcvdByte"]').eq(0).addClass("td-na"),$('[data-field="utmAction"]').eq(0).addClass("td-na"),$('[data-field="attack"]').eq(0).addClass("td-na")):"INTRUSION"==a?($('[data-field="service"]').eq(0).addClass("td-na"),$('[data-field="url"]').eq(0).addClass("td-na"),$('[data-field="app"]').eq(0).addClass("td-na"),$('[data-field="sentByte"]').eq(0).addClass("td-na"),$('[data-field="rcvdByte"]').eq(0).addClass("td-na"),$('[data-field="utmAction"]').eq(0).addClass("td-na"),$('[data-field="level"]').eq(0).addClass("td-na"),$('[data-field="user"]').eq(0).addClass("td-na"),$('[data-field="message"]').eq(0).addClass("td-na")):"WEBFILTER"==a&&($('[data-field="severity"]').eq(0).addClass("td-na"),$('[data-field="srcCountry"]').eq(0).addClass("td-na"),$('[data-field="app"]').eq(0).addClass("td-na"),$('[data-field="utmAction"]').eq(0).addClass("td-na"),$('[data-field="level"]').eq(0).addClass("td-na"),$('[data-field="user"]').eq(0).addClass("td-na"),$('[data-field="message"]').eq(0).addClass("td-na"),$('[data-field="attack"]').eq(0).addClass("td-na")),$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust(),startNum=pageLength,lastScrollYPos=$(".dataTables_scrollBody").prop("scrollTop"),getTotalFilteredCount(),bindTrEvent()},rowCallback:function(e,a){$("td:eq(4)",e).attr("data-field","severity"),$("td:eq(5)",e).attr("data-field","srcIp"),$("td:eq(6)",e).attr("data-field","srcPort"),$("td:eq(7)",e).attr("data-field","srcCountry"),$("td:eq(8)",e).attr("data-field","dstIp"),$("td:eq(9)",e).attr("data-field","dstPort"),$("td:eq(10)",e).attr("data-field","proto"),$("td:eq(11)",e).attr("data-field","service"),$("td:eq(12)",e).attr("data-field","url"),$("td:eq(13)",e).attr("data-field","app"),$("td:eq(14)",e).attr("data-field","action"),$("td:eq(15)",e).attr("data-field","sentByte"),$("td:eq(16)",e).attr("data-field","rcvdByte"),$("td:eq(17)",e).attr("data-field","utmAction"),$("td:eq(18)",e).attr("data-field","level"),$("td:eq(19)",e).attr("data-field","user"),$("td:eq(20)",e).attr("data-field","message"),$("td:eq(21)",e).attr("data-field","attack")},columns:[{},{data:"type"},{data:"devName"},{data:"dateStr"},{data:"timeStr"},{data:"severity"},{data:"srcIp"},{data:"srcPort"},{data:"srcCountry"},{data:"dstIp"},{data:"dstPort"},{data:"proto"},{data:"service"},{data:"url"},{data:"app"},{data:"action"},{data:"sentByte",className:"right"},{data:"rcvdByte",className:"right"},{data:"utmAction"},{data:"level"},{data:"user"},{data:"message"},{data:"attack"}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(e,a,t,d){return d.row+d.settings._iDisplayStart+1}}]}))):alert(msg_chooseTime):alert(msg_chooseDate)}$(document).ready(function(){initMenuStatus("toggleMenu_plugin","toggleMenu_plugin_items","cm_firewallLog"),startNum=0,pageLength=Number($("#pageLength").val()),$("input").val("");new Cleave(".input-port",{numericOnly:!0,blocks:[5]});$("#resultTable").on("xhr.dt",function(e,a,t,d){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg))});var e=new Date,a=e.getFullYear(),t=parseInt(e.getMonth())+1;t=t<10?"0".concat(t):t;var d=e.getDate(),l=a+"-"+t+"-"+(d=d<10?"0".concat(d):d);$("#queryDateBegin").val(l),$("#queryDateEnd").val(l),$("#queryTimeBegin").val("00:00"),$("#queryTimeEnd").val("23:59"),$("#queryType").change(function(){"SYSTEM"==$(this).val()?($("#querySrcIp").val(""),$("#querySrcPort").val(""),$("#queryDstIp").val(""),$("#queryDstPort").val(""),$("[data-ipPortSec]").hide()):$("[data-ipPortSec]").show()})});