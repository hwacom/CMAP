var timer,startTime,timer_start,timer_end,startNum,pageLength,waitForNextData=!1,lastScrollYPos=0;function bindScrollEvent(){$(".dataTables_scrollBody").scroll(function(e){if(0==$(".dataTables_empty").length){var t=$("#resultTable > tBody > tr").length,a=$(this).prop("scrollTop"),n=$(this).prop("scrollHeight")-$(this).prop("clientHeight");a>lastScrollYPos&&(lastScrollYPos=a,t>=pageLength&&a>=n-100&&(waitForNextData||(waitForNextData=!0,findNextData())))}})}function unbindScrollEvent(){$(".dataTables_scrollBody").off("scroll")}function countDown(e){if("START"==e)startTime=parseInt(_timeout)-1,timer_start=performance.now(),timer=setInterval(function(){$("#timeoutMsg").val("Timeout倒數 : "+startTime+" 秒"),startTime--},1e3);else{timer_end=performance.now();var t=(parseInt(timer_end)-parseInt(timer_start))/1e3;$("#timeoutMsg").val("查詢花費時間 : "+t+" 秒"),clearInterval(timer)}}function addRow(e){for(var t=0;t<e.length;t++){var a=e[t],n=$("#resultTable > tBody > tr").length,r=$("#resultTable > tbody > tr:eq(0)").clone();$(r).find("td:eq(0)").html(++n),$(r).find("td:eq(1)").html(a.clientIp),$(r).find("td:eq(2)").html(a.ipDesc),$(r).find("td:eq(3)").html(a.startTime),$(r).find("td:eq(4)").html(a.endTime),$(r).find("td:eq(5)").html(a.clientMac),$(r).find("td:eq(6)").html(a.groupName),$(r).find("td:eq(7)").html(a.deviceName),$(r).find("td:eq(8)").html(a.portName),$("#resultTable > tbody").append($(r))}$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust()}function getTotalFilteredCount(){$.ajax({url:_ctx+"/plugin/module/ipTracePoller/getTotalFilteredCount.json",data:{queryGroupId:$("#queryGroup").val(),queryDevice:$("#queryDevice").val(),queryDateBegin:$("#query_DateBegin").val(),queryDateEnd:$("#query_DateEnd").val(),queryTimeBegin:$("#query_TimeBegin").val(),queryTimeEnd:$("#query_TimeEnd").val(),queryClientMac:$("#query_ClientMac").val(),queryClientIp:$("#query_ClientIp").val(),queryOnLineOnly:document.getElementById("query_OnlineOnly").checked},type:"POST",dataType:"json",async:!0,beforeSend:function(e){var t,a;0==$(".dataTables_empty").length?(t=1,a=$("#resultTable > tBody > tr").length):(t=0,a=0),$("#resultTable_info").html('<div class="row" style="padding-left: 15px;"><div id="current_count">顯示第 '+t+" 至 "+a+' 項結果，共</div><div id="total_count"><img id="searchWaiting2" class="img_searchWaiting" alt="loading..." src="/resources/images/Processing_4.gif"></div><div style="">筆</div></div>')},complete:function(){$("#searchWaiting2").hide()},initComplete:function(e,t){},success:function(e){var t=e.data.FILTERED_COUNT;$("#total_count").html("&nbsp;"+t+"&nbsp;")},error:function(e,t,a){$("#total_count").html("&nbsp;N/A&nbsp;")}})}function findNextData(){var e,t=-1;$(".dataTable > thead").find(".sorting_asc").length>0?t=$(".dataTable > thead").find(".sorting_asc").prop("cellIndex"):$(".dataTable > thead").find(".sorting_desc").length>0&&(t=$(".dataTable > thead").find(".sorting_desc").prop("cellIndex")),e="descending"===$(".dataTable > thead > tr > th:eq("+t+")").attr("aria-sort")?"desc":"asc",$.ajax({url:_ctx+"/plugin/module/ipTracePoller/getIpTraceData.json",data:{queryGroupId:$("#queryGroup").val(),queryDevice:$("#queryDevice").val(),queryDateBegin:$("#query_DateBegin").val(),queryDateEnd:$("#query_DateEnd").val(),queryTimeBegin:$("#query_TimeBegin").val(),queryTimeEnd:$("#query_TimeEnd").val(),queryClientMac:$("#query_ClientMac").val(),queryClientIp:$("#query_ClientIp").val(),queryOnLineOnly:document.getElementById("query_OnlineOnly").checked,start:startNum,length:pageLength,"order[0][column]":t,"order[0][dir]":e},type:"POST",dataType:"json",async:!0,beforeSend:function(e){countDown("START"),showProcessing()},complete:function(){countDown("STOP"),hideProcessing(),waitForNextData=!1},initComplete:function(e,t){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg))},success:function(e){var t,a,n=e.data.length;console.log("query success... count: "+n),n>0&&(addRow(e.data),startNum+=pageLength),0==$(".dataTables_empty").length?(t=1,a=$("#resultTable > tBody > tr").length):(t=0,a=0),$("#current_count").text("顯示第 "+t+" 至 "+a+" 項結果，共")},error:function(e,t,a){$("#current_count").text("<ERROR>"),ajaxErrorHandler()}})}function findData(e){var t,a,n,r,l,i;if($("#queryFrom").val(e),t=0!=$("#queryGroup").val().trim().length?"Y":"N",null!=$("#queryDevice").val()&&0!=$("#queryDevice").val().trim().length?"Y":"N",l=0!=$("#query_ClientIp").val().trim().length?"Y":"N",i=0!=$("#query_ClientMac").val().trim().length?"Y":"N",0!=$("#query_DateBegin").val().trim().length&&0!=$("#query_TimeBegin").val().trim().length)a="Y";else{if(0!=$("#query_DateBegin").val().trim().length||0!=$("#query_TimeBegin").val().trim().length)return void alert(msg_chooseDate);a="N"}if(0!=$("#query_DateEnd").val().trim().length&&0!=$("#query_TimeEnd").val().trim().length)n="Y";else{if(0!=$("#query_DateEnd").val().trim().length||0!=$("#query_TimeEnd").val().trim().length)return void alert(msg_chooseDate);n="N"}r="N"==a&&"N"==n?"N":"Y","N"!=t||"N"!=l||"N"!=i||"N"!=r?("MOBILE"==e&&$("#collapseExample").collapse("hide"),startNum=0,"undefined"!=typeof resultTable?($(".dataTables_scrollBody").scrollTop(0),resultTable.ajax.reload(),$(".myTableSection").show()):($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!1,bFilter:!1,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:pageLength,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},createdRow:function(e,t,a){},ajax:{url:_ctx+"/plugin/module/ipTracePoller/getIpTraceData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?(e.queryGroupId=$("#queryGroup").val(),e.queryDevice=$("#queryDevice").val(),e.queryDateBegin=$("#query_DateBegin").val(),e.queryDateEnd=$("#query_DateEnd").val(),e.queryTimeBegin=$("#query_TimeBegin").val(),e.queryTimeEnd=$("#query_TimeEnd").val(),e.queryClientMac=$("#query_ClientMac").val(),e.queryClientIp=$("#query_ClientIp").val(),e.queryOnLineOnly=document.getElementById("query_OnlineOnly").checked):"MOBILE"==$("#queryFrom").val()&&(e.queryGroupId=$("#queryGroup_mobile").val(),e.queryDate=$("#query_Date_mobile").val(),e.queryTimeBegin=$("#query_TimeBegin_mobile").val(),e.queryTimeEnd=$("#query_TimeEnd_mobile").val(),e.queryClientMac=$("#query_ClientMac_mobile").val(),e.queryClientIp=$("#query_ClientIp_mobile").val(),e.queryOnLineOnly=document.getElementById("query_OnlineOnly").checked),e.start=0,e.length=pageLength,e},beforeSend:function(){countDown("START")},complete:function(){countDown("STOP")},error:function(e,t,a){ajaxErrorHandler()},timeout:1e3*parseInt(_timeout)},order:[[3,"desc"]],initComplete:function(e,t){null!=t.msg&&($(".myTableSection").hide(),alert(t.msg)),bindScrollEvent()},drawCallback:function(e){$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),startNum=pageLength,lastScrollYPos=$(".dataTables_scrollBody").prop("scrollTop"),getTotalFilteredCount(),bindTrEvent()},columns:[{},{data:"clientIp",orderable:!0},{data:"ipDesc"},{data:"startTime",orderable:!0},{data:"endTime",orderable:!0},{data:"clientMac",orderable:!0},{data:"groupName",orderable:!0},{data:"deviceName",orderable:!0},{data:"portName",orderable:!0}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(e,t,a,n){return n.row+n.settings._iDisplayStart+1}}]}))):alert(msg_chooseOne)}$(document).ready(function(){initMenuStatus("toggleMenu_prtg","toggleMenu_prtg_items","cm_iptrace"),startNum=0,pageLength=Number($("#pageLength").val());new Cleave(".input-port",{numericOnly:!0,blocks:[5]});$("#resultTable").on("xhr.dt",function(e,t,a,n){null!=a.msg&&($(".myTableSection").hide(),alert(a.msg))}),$("#query_ClientMac").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_ClientIp").unbind("blur").bind("blur",function(){$(this).val($(this).val().trim())}),$("#query_OnlineOnly").click(function(){$("#query_OnlineOnly").prop("checked")?($("#query_DateBegin").val(""),$("#query_DateEnd").val(""),$("#query_TimeBegin").val(""),$("#query_TimeEnd").val("")):($("#query_DateBegin").val(t+"-"+a+"-"+n),$("#query_DateEnd").val(t+"-"+a+"-"+n),$("#query_TimeBegin").val("00:00"),$("#query_TimeEnd").val("23:59"))});var e=new Date,t=e.getFullYear(),a=parseInt(e.getMonth())+1;a=a<10?"0".concat(a):a;var n=e.getDate();n=n<10?"0".concat(n):n,$("#query_DateBegin").val(t+"-"+a+"-"+n),$("#query_DateEnd").val(t+"-"+a+"-"+n),$("#query_TimeBegin").val("00:00"),$("#query_TimeEnd").val("23:59"),changeDeviceMenu("queryDevice",$("#queryGroup").val())});