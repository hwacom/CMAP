var scriptShowMaxLine=2,_SCRIPT_TYPE_="SCRIPT_TYPE",STEP_NUM=1,scriptCodeCheck=!1;function showScriptContent(e,t,a){var n=new Object;n.scriptInfoId=e,n.type=t,$.ajax({url:_ctx+"/script/view",data:JSON.stringify(n),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",async:!0,success:function(e){if("200"==e.code){if("showContent"==a)$("#viewScriptModal_scriptName").val(e.data.scriptName),$("#viewScriptModal_scriptContent").html(e.data.content),$("#viewScriptModal").modal("show");else if("modifyInfo"==a){if("Y"==e.data.systemDefault)return void alert("此為系統預設腳本不可異動!!");$("#addScriptCode").val(e.data.scriptCode).attr("readonly","readonly"),$("#addScriptName").val(e.data.scriptName),$("#addScriptRemark").val(e.data.remark),$("#addScriptContent").val(e.data.content);for(var t=document.getElementById("addDeviceModel"),n=0,i=t.options.length;n<i;n++)if(e.data.model===t.options[n].value){t.options[n].selected=!0;break}$("#stepModal").modal({backdrop:"static"}),window.sessionStorage.setItem("addScriptType",e.data.type)}}else alert(e.message)},error:function(e,t,a){ajaxErrorHandler()}})}function getPartialContent(e){var t="";if(null!=e&&""!=e){var a=e.split("<br>");if(a.length>scriptShowMaxLine){for(var n=0;n<scriptShowMaxLine;n++)t+=a[n],n!=scriptShowMaxLine-1&&(t+="<br>");t+='&nbsp;&nbsp;<a href="javascript:void(0);" >...(顯示)</a>'}else t=e}return t}function findData(e){$("#queryFrom").val(e),$("input[name=checkAll]").prop("checked",!1),"MOBILE"==e&&$("#collapseExample").collapse("hide"),"undefined"!=typeof resultTable?(resultTable.clear().draw(),resultTable.ajax.reload()):($(".myTableSection").show(),resultTable=$("#resultTable").DataTable({autoWidth:!0,paging:!0,bFilter:!0,ordering:!0,info:!0,serverSide:!0,bLengthChange:!0,pagingType:"full",processing:!0,scrollX:!0,scrollY:dataTableHeight,scrollCollapse:!0,pageLength:100,language:{url:_ctx+"/resources/js/dataTable/i18n/Chinese-traditional.json"},ajax:{url:_ctx+"/script/getScriptData.json",type:"POST",data:function(e){return"WEB"==$("#queryFrom").val()?e.queryScriptTypeCode=$("#queryScriptType").val():"MOBILE"==$("#queryFrom").val()&&(e.queryScriptTypeCode=$("#queryScriptType_mobile").val()),e},error:function(e,t,a){ajaxErrorHandler()}},order:[[3,"asc"]],initComplete:function(e,t){},drawCallback:function(e){$.fn.dataTable.tables({visible:!0,api:!0}).columns.adjust(),$("div.dataTables_length").parent().removeClass("col-sm-12"),$("div.dataTables_length").parent().addClass("col-sm-6"),$("div.dataTables_filter").parent().removeClass("col-sm-12"),$("div.dataTables_filter").parent().addClass("col-sm-6"),$("div.dataTables_info").parent().removeClass("col-sm-12"),$("div.dataTables_info").parent().addClass("col-sm-6"),$("div.dataTables_paginate").parent().removeClass("col-sm-12"),$("div.dataTables_paginate").parent().addClass("col-sm-6"),initCheckedItems(),bindTrEvent()},createdRow:function(e,t,a){0==t.enableModify&&$(e).children("td").eq(0).addClass("hide"),null!=t.actionScript&&($(e).children("td").eq(5).attr("onclick","javascript:showScriptContent('"+t.scriptInfoId+"', 'A', 'showContent');"),$(e).children("td").eq(5).addClass("cursor_zoom_in")),null!=t.checkScript&&($(e).children("td").eq(7).attr("onclick","javascript:showScriptContent('"+t.scriptInfoId+"', 'C', 'showContent');"),$(e).children("td").eq(7).addClass("cursor_zoom_in"))},columns:[{},{},{data:"scriptName"},{data:"scriptTypeName",className:"center"},{data:"deviceModel",className:"center"},{},{data:"actionScriptRemark"},{},{data:"checkScriptRemark"},{data:"createTimeStr",className:"center"},{data:"updateTimeStr",className:"center"}],columnDefs:[{targets:[0],className:"center",searchable:!1,orderable:!1,render:function(e,t,a){return'<input type="radio" id="radiobox" name="radiobox" onclick="resetTrBgColor();changeTrBgColor(this)" value='+a.scriptInfoId+">"}},{targets:[1],className:"center",searchable:!1,orderable:!1,render:function(e,t,a,n){return n.row+n.settings._iDisplayStart+1}},{targets:[5],className:"left",searchable:!0,orderable:!0,render:function(e,t,a,n){return getPartialContent(a.actionScript)}},{targets:[7],className:"left",searchable:!0,orderable:!0,render:function(e,t,a,n){return getPartialContent(a.checkScript)}}]}))}function showPanel(e){if(window.sessionStorage.clear(),STEP_NUM=1,initStepBtn(),initStepImg(),$("#step1_section").show(),$("#step2_section").hide(),$("#step3_section").hide(),"add"==e){var t=$("input[name=input_var]");t.length>0&&$.each(t,function(e,t){t.value=""}),scriptCodeCheck=!1,$("#stepModal").modal({backdrop:"static"}),window.sessionStorage.setItem("addScriptType",$("#queryScriptType :selected").val())}else"modify"==e&&(showScriptContent($("input[name='radiobox']:checked").val(),"A","modifyInfo"),scriptCodeCheck=!0)}function initStepBtn(){switch(STEP_NUM){case 1:$("#btnStepGoPrev").hide(),$("#btnStepGoNext").show(),$("#btnStepGoFire").hide();break;case 2:$("#btnStepGoPrev").show(),$("#btnStepGoNext").show(),$("#btnStepGoFire").hide();break;case 3:$("#btnStepGoPrev").show(),$("#btnStepGoNext").hide(),$("#btnStepGoFire").show()}}function initStepImg(){var e=parseInt(STEP_NUM)-1;$(".step-img").removeClass("step-current"),$(".step-img").eq(e).addClass("step-current")}function goStep(e){var t=parseInt(STEP_NUM)+parseInt(e),a=parseInt(STEP_NUM);if(!(parseInt(t)>parseInt(a))||($(".required").removeClass("required"),checkB4Next(a))){if(1==STEP_NUM&&2==t)$("#currentIndex").val(1),$("#showContentValue").val(window.sessionStorage.getItem("addScriptContentValue").split(",")[0]),(i=$("input[name=input_var2]")).length>0&&$.each(i,function(e,t){t.value=""});else if(2==STEP_NUM&&1==t){if($("#currentIndex").val()>1){(i=$("input[name=input_var2]")).length>0&&$.each(i,function(e,t){var a=window.sessionStorage.getItem(t.id);t.value=a.substring(a.lastIndexOf(",")+1,a.length),window.sessionStorage.setItem(t.id,a.substring(0,a.lastIndexOf(",")))});var n=parseInt($("#currentIndex").val())-1;if($("#currentIndex").val(n),$("#showContentValue").val(window.sessionStorage.getItem("addScriptContentValue").split(",")[n-1]),1==n)(i=$("input[name=input_var2]")).length>0&&$.each(i,function(e,t){window.sessionStorage.removeItem(t.id)});return}}else if(3==STEP_NUM&&2==t){(i=$("input[name=input_var2]")).length>0&&$.each(i,function(e,t){var a=window.sessionStorage.getItem(t.id);t.value=a.substring(a.lastIndexOf(",")+1,a.length),window.sessionStorage.setItem(t.id,a.substring(0,a.lastIndexOf(",")))})}else if(2==STEP_NUM&&3==t&&$("#currentIndex").val()<window.sessionStorage.getItem("addScriptContentLine")){var i;n=parseInt($("#currentIndex").val())+1;return $("#currentIndex").val(n),$("#showContentValue").val(window.sessionStorage.getItem("addScriptContentValue").split(",")[n-1]),void((i=$("input[name=input_var2]")).length>0&&$.each(i,function(e,t){t.value=""}))}$("#step"+t+"_section").show(),$("#step"+a+"_section").hide(),STEP_NUM=parseInt(STEP_NUM)+parseInt(e),initStepBtn(),initStepImg()}}function checkB4Next(e){var t=[],a=[];switch(e){case 1:if(!scriptCodeCheck)return!1;var n=$("input[name=input_var]"),i=$("textarea[name=input_var]"),r=!0;if(n.length>0&&$.each(n,function(e,a){a.required&&0==a.value.trim().length?(r=!1,t.push(a)):window.sessionStorage.setItem(a.id,a.value.trim())}),i.length>0){var o=0;$.each(i,function(e,n){if(n.required&&0==n.value.trim().length)r=!1,t.push(n);else{var i=n.value.trim().split(/\r?\n|\r/g);$.each(i,function(e,t){t.trim().length>0&&(a.push(t.trim()),o++)}),window.sessionStorage.setItem(n.id+"Value",a),window.sessionStorage.setItem(n.id+"Line",o)}})}return r?(window.sessionStorage.setItem("addDeviceModel",$("#addDeviceModel :selected").val()),r):($.each(t,function(e,t){$(t).addClass("required")}),alert("請輸入變數值"),!1);case 2:n=$("input[name=input_var2]"),r=!0;return n.length>0&&$.each(n,function(e,n){n.required&&0==n.value.trim().length?(console.log("input word : id = "+n.id+", is required!!"),r=!1,t.push(n)):(a=null!=window.sessionStorage.getItem(n.id)?new Array(window.sessionStorage.getItem(n.id)):[],""==n.value.trim()&&(n.value=""),a.push(n.value),window.sessionStorage.setItem(n.id,a))}),r||($.each(t,function(e,t){$(t).addClass("required")}),alert("請輸入變數值"),!1);case 3:return r}}function checkScriptCode(){var e=new Object;e.scriptCode=$("#addScriptCode").val().trim();$.ajax({url:_ctx+"/script/checkScriptCode.json",data:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",async:!0,success:function(e){"200"==e.code?(alert(e.message),scriptCodeCheck=!0):(alert(e.message),scriptCodeCheck=!1)},error:function(e,t,a){ajaxErrorHandler(),scriptCodeCheck=!1}})}function envAction(e){if("add"==e){for(var t=new Object,a="",n=0;n<window.sessionStorage.length;n++)t[a=window.sessionStorage.key(n)]=window.sessionStorage.getItem(a);doActionAjax(t,"save")}else if("saveType"==e){(t=new Object).scriptTypeCode=$("#scriptTypeCode").val(),t.scriptTypeName=$("#scriptTypeName").val(),doActionAjax(t,"saveType")}}function doDeleteActionAjax(){var e=new Object,t=$("input[name='radiobox']:checked").val();e.scriptInfoId=t,doActionAjax(e,"delete")}function doActionAjax(e,t){$.ajax({url:_ctx+"/script/"+t,data:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",dataType:"json",async:!0,beforeSend:function(){showProcessing()},complete:function(){hideProcessing()},success:function(e){"200"==e.code?(alert(e.message),findData($("#queryFrom").val()),"save"==t&&setTimeout(function(){$("#stepModal").modal("hide")},500)):(alert("envAction > success > else :: resp.code: "+e.code),alert(e.message))},error:function(e,t,a){ajaxErrorHandler()}})}$(document).ready(function(){initMenuStatus("toggleMenu_cm","toggleMenu_cm_items","cm_script"),$("#btnAdd").click(function(e){""!=$("#queryScriptType :selected").val()?showPanel("add"):alert(msg_chooseType)}),$("#btnModify").click(function(){if(0==$("input[name=radiobox]:checked:eq(0)").length)return alert("請選取修改項目！"),!1;showPanel("modify")}),$("#btnDelete").click(function(e){if(0==$("input[name=radiobox]:checked:eq(0)").length)return alert("請選取刪除項目！"),!1;confirm("請確認是否刪除","doDeleteActionAjax")}),$("#btnStepGoPrev").click(function(e){goStep(-1)}),$("#btnStepGoNext").click(function(e){e.preventDefault(),goStep(1)}),$("#btnStepGoFire").click(function(e){envAction("add")}),$("#addScriptCode").unbind("blur").bind("blur",function(){0==$("input[name=radiobox]:checked:eq(0)").length&&checkScriptCode()}),$("#btnTypeModify").click(function(e){window.sessionStorage.clear();var t=$("#queryScriptType :selected");""==t.val()?($("#scriptTypeName").val(""),$("#scriptTypeCode").val("")):($("#scriptTypeName").val(t.text()),$("#scriptTypeCode").val(t.val())),$("#addModifyModal").modal({backdrop:"static"})}),$("#btnSave").click(function(){envAction("saveType")})});